<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generating WKT Map - Map Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header {
            background: linear-gradient(135deg, #006a4e 0%, #228b22 100%);
            color: white;
            padding: 1.5rem 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        }
        .progress-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 20px;
            position: relative;
            z-index: 10;
        }
        .status-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .spinner {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-steps {
            margin: 1.2rem 0;
        }
        .step {
            padding: 0.7rem;
            margin: 0.3rem 0;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .step.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .step.completed {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        .step.error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .download-section {
            display: none;
            text-align: center;
            margin-top: 2rem;
        }
        .btn-download {
            background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%);
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 1rem;
        }
        .error-section {
            display: none;
            text-align: center;
            margin-top: 2rem;
        }
        body {
            background: linear-gradient(135deg, #f0f8f0 0%, #e8f5e8 100%);
            min-height: 100vh;
        }
        .header h3 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 2rem;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.7);
        }
        .header p {
            font-size: 1.2rem;
            font-weight: 500;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container text-center">
            <h3><i class="fas fa-cogs"></i> Generating Your WKT Map</h3>
            <p class="mb-0">Processing: {{ city_name }} ({{ detail_level }} level)</p>
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="progress-container">
                    <!-- Status Display -->
                    <div class="text-center" id="statusDisplay">
                        <div class="status-icon">
                            <i class="fas fa-cogs spinner text-primary" id="statusIcon"></i>
                        </div>
                        <h3 id="statusTitle">Initializing...</h3>
                        <p class="text-muted" id="statusMessage">Setting up the map generation process...</p>
                    </div>

                    <!-- Progress Steps -->
                    <div class="progress-steps">
                        <div class="step" id="step1">
                            <i class="fas fa-search text-primary"></i>
                            <strong>Testing Location</strong> - Verifying if the location exists in OpenStreetMap
                        </div>
                        <div class="step" id="step2">
                            <i class="fas fa-cloud-download-alt text-primary"></i>
                            <strong>Downloading Data</strong> - Fetching map data from OpenStreetMap
                        </div>
                        <div class="step" id="step3">
                            <i class="fas fa-project-diagram text-primary"></i>
                            <strong>Processing Roads</strong> - Converting map data to WKT format
                        </div>
                        <div class="step" id="step4">
                            <i class="fas fa-file-export text-primary"></i>
                            <strong>Generating File</strong> - Creating your WKT file
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" style="width: 0%"></div>
                    </div>

                    <!-- Download Section -->
                    <div class="download-section" id="downloadSection">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Success!</strong> Your WKT map has been generated successfully.
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <i class="fas fa-road fa-2x text-primary mb-2"></i>
                                        <h5 id="segmentCount">0</h5>
                                        <small class="text-muted">Road Segments</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <i class="fas fa-layer-group fa-2x text-success mb-2"></i>
                                        <h5 id="roadTypes">0</h5>
                                        <small class="text-muted">Road Types</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <i class="fas fa-file-alt fa-2x text-info mb-2"></i>
                                        <h5>WKT</h5>
                                        <small class="text-muted">File Format</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <a href="#" class="btn btn-download text-white btn-lg" id="downloadBtn">
                            <i class="fas fa-download"></i> Download WKT File
                        </a>
                        
                        <div class="mt-3">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-plus"></i> Generate Another Map
                            </a>
                        </div>
                    </div>

                    <!-- Error Section -->
                    <div class="error-section" id="errorSection">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Error!</strong> <span id="errorMessage">Something went wrong.</span>
                        </div>
                        
                        <div class="mt-3">
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="fas fa-arrow-left"></i> Try Again
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const jobId = '{{ job_id }}';
        let currentStep = 0;
        const steps = ['step1', 'step2', 'step3', 'step4'];
        
        function updateStep(stepIndex, status = 'active') {
            // Reset all steps
            steps.forEach((step, index) => {
                const element = document.getElementById(step);
                element.classList.remove('active', 'completed', 'error');
                
                if (index < stepIndex) {
                    element.classList.add('completed');
                } else if (index === stepIndex) {
                    element.classList.add(status);
                }
            });
            
            // Update progress bar
            const progress = ((stepIndex + 1) / steps.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function updateStatus(status, message, title) {
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            
            statusTitle.textContent = title || 'Processing...';
            statusMessage.textContent = message || 'Please wait...';
            
            // Update icon based on status
            statusIcon.className = 'fas fa-2x ';
            switch(status) {
                case 'testing':
                    statusIcon.className += 'fa-search spinner text-primary';
                    updateStep(0);
                    break;
                case 'downloading':
                    statusIcon.className += 'fa-cloud-download-alt spinner text-primary';
                    updateStep(1);
                    break;
                case 'processing':
                    statusIcon.className += 'fa-project-diagram spinner text-primary';
                    updateStep(2);
                    break;
                case 'generating':
                    statusIcon.className += 'fa-file-export spinner text-primary';
                    updateStep(3);
                    break;
                case 'completed':
                    statusIcon.className += 'fa-check-circle text-success';
                    updateStep(3, 'completed');
                    document.getElementById('progressBar').style.width = '100%';
                    break;
                case 'error':
                    statusIcon.className += 'fa-exclamation-triangle text-danger';
                    updateStep(currentStep, 'error');
                    break;
            }
        }
        
        function checkStatus() {
            fetch(`/status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Status:', data);
                    
                    switch(data.status) {
                        case 'starting':
                            updateStatus('testing', data.message, 'Initializing...');
                            break;
                        case 'testing':
                            updateStatus('testing', data.message, 'Testing Location');
                            break;
                        case 'downloading':
                            updateStatus('downloading', data.message, 'Downloading Map Data');
                            break;
                        case 'processing':
                            updateStatus('processing', data.message, 'Processing Roads');
                            break;
                        case 'generating':
                            updateStatus('generating', data.message, 'Generating WKT File');
                            break;
                        case 'completed':
                            updateStatus('completed', 'Your WKT file is ready!', 'Generation Complete');
                            showDownloadSection(data);
                            return; // Stop polling
                        case 'error':
                            updateStatus('error', data.error, 'Generation Failed');
                            showErrorSection(data.error);
                            return; // Stop polling
                    }
                    
                    // Continue polling
                    setTimeout(checkStatus, 2000);
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    updateStatus('error', 'Connection error', 'Error');
                    showErrorSection('Unable to check generation status');
                });
        }
        
        function showDownloadSection(data) {
            // Hide status display
            document.getElementById('statusDisplay').style.display = 'none';
            
            // Show download section
            const downloadSection = document.getElementById('downloadSection');
            downloadSection.style.display = 'block';
            
            // Update statistics
            if (data.counts) {
                const totalSegments = Object.values(data.counts).reduce((a, b) => a + b, 0);
                const roadTypes = Object.keys(data.counts).length;
                
                document.getElementById('segmentCount').textContent = totalSegments.toLocaleString();
                document.getElementById('roadTypes').textContent = roadTypes;
            }
            
            // Set download link
            document.getElementById('downloadBtn').href = `/download/${jobId}`;
        }
        
        function showErrorSection(errorMessage) {
            // Hide status display
            document.getElementById('statusDisplay').style.display = 'none';
            
            // Show error section
            const errorSection = document.getElementById('errorSection');
            errorSection.style.display = 'block';
            
            document.getElementById('errorMessage').textContent = errorMessage;
        }
        
        // Start checking status
        setTimeout(checkStatus, 1000);
    </script>
</body>
</html>